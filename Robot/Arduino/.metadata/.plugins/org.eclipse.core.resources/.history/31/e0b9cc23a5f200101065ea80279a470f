#include <WProgram.h>
#include "UserCode.h"
#include "UserConstants.h"
#include <FrcComms\FRCCommunication.h>
#include <FrcComms\Configuration.h>
#include <Ethernet.h>
#include <FrcComms\CRC32.h>

//const int interval = 250; //Milliseconds
Configuration *config;
FRCCommunication *comm;
UserRobot robot;

int main() {
	//Initialize the Arduino library.
	//Not doing so will prevent the delay function
	//from working. Calling this functions is a must
	//for all arduino projects.
	setup();
	while (true) {
		loop();
	}
	//Unreachable code but it's required by
	//the compiler
	return 0;
}

void setup() {
	init();
	Serial.begin(9600);

	Serial.println("Ready.");
}

unsigned long lastLoopTime = 0;
unsigned long nextLoopTime = 0;
unsigned long fixedLoopPeriod = 0;
void loop() {
	config->poll();
	if (comm->newDataReady()){
		robot.commLoop();
		comm->sendData();
	}
	unsigned long now = millis();
	if (nextLoopTime == 0)
	{
		fixedLoopPeriod = 1000/FIXED_LOOP_FREQUENCY;
		nextLoopTime = now;
		lastLoopTime = 0;
	}
	if (now >= nextLoopTime){
		robot.fixedLoop(now - nextLoopTime, now - lastLoopTime);
		nextLoopTime += fixedLoopPeriod;
		lastLoopTime = now;
	}
	robot.fastLoop();
}
